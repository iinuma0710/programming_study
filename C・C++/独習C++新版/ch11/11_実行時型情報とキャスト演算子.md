# 第11章 実行時型情報とキャスト演算子

## 11.1 実行時型情報 (RTTI)
実行時型情報 (RTTI: RunTime Type Information) とは，実行時にそのオブジェクトの型について調べる機能である．
クラスは基底クラスとして使われることもあり，コンパイル時の型からは実行時に実際にどの派生クラスを指しているか分からない場合がある．
そこで，実行時型情報を用いることで，オブジェクトが実際にはどのクラスなのかを識別し，それによって処理を変えることができる．

### 11.1.1 typeid 演算子と std::type_info クラス
```<typeinfo>``` ヘッダをインクルードした上で ```typeid``` 演算子を用いて実行時型情報を取得する．
```typeid``` 演算子は ```std::type_info``` クラスのオブジェクトへの参照を返す．
```std::type_info``` クラスのインスタンスは，他のインスタンスと比較して同じ型であるかを取得できる．

```cpp
// 式の結果の型の実行時型情報を取得
typeid(expression)

// 型から直接実行時型情報を取得
typeid(type-name)
```

インスタンス間の型の比較は，全く同じ型か否かのみを判定しており，継承関係や包含関係にあったとしても，
異なる型情報を持つものとして扱われる．

### 11.1.2 派生クラスの実行時型情報
```typeid``` 演算子は，ポリモーフィックなオブジェクトについてオブジェクト本来の型に関する情報を返す．
つまり，基底クラスのポインタや参照を使ったとしても，実際に作られた派生クラスの情報を返す．
これによって，関数を共通化しつつ特定のクラスだけ特別な処理をすることができるようになる．

## 11.2 キャスト演算子
ある変数を別の型に変換するキャスト演算子 (cast operators) について見ていく．

### 11.2.1 C言語形式のキャスト
C 言語でサポートされているキャスト演算子を C 形式キャスト (C-style cast) と呼ぶ．
C++ ではより安全なキャストを用意しているため，ほとんど使われることはない．

```cpp
(type-name)expression
```

### 11.2.2 static_cast / const_cast / reinterpret_cast
C++ では方を無視したプログラムは推奨されていないので，C 形式キャストの使用は避けるべきである．
その代わり，次のような4種類のキャスト演算子が定義されれいる．

```cpp
static_cast<target-type>(expression)

const_cast<target-type>(expression)

reinterpret_cast<target-type>(expression)

dynamic_cast<target-type>(expression)
```

- ```static_cast```  
コンパイル時に与えられた方情報に基づいた型変換を行う
数値型の変数をサイズや精度の異なる別の数値型へ変換したり，
ポインタ型と ```void*``` 型との相互変換やクラスへの参照やポインタを基底クラスや派生クラスへ変換したりする．

- ```const_cast```  
ポインタや参照から ```const``` を付けたり外したりするのに使われる．
この際，他の方への変換が行われるような場合にはエラーとなる．
主に，C 言語で提供されている関数の呼び出し時に，その関数に渡す実引数の方を合わせるためだけに使われる．

- ```reinterpret_cast```  
上記2つのキャスト演算子では扱うことのできないような型変換を行う．
本来であれば許されないようなキャストを行うことになるため，ハードウェアについてもよく理解した上で使用する必要がある．

## 11.3 dynamic_cast の利用
```dynamic_cast``` はポリモーフィックなクラスで使用するために導入されたキャスト演算子で，
実行時にキャストできることを確認してからキャストする場合に用いる．
ポインタのキャストに失敗した場合には ```nullptr``` を返し，参照のキャストに失敗した場合には ```std::bad_cast``` 例外を投げるため，
これらをもとにエラー処理を行う．

### 11.3.1 アップキャスト
派生クラスから基底クラスへとキャストすることをアップキャスト (up cast) と呼ぶ．
アップキャストでは制限なく基底クラスへのポインタなどに代入できるため，```static_cast``` を使用すれば良い．

### 11.3.2 ダウンキャスト・クロスキャスト
基底クラスから派生クラスにキャストすることをダウンキャスト (down cast) と呼び，
「直接の派生関係はないが，派生クラスが他の暮らせも基底クラスとして使っていた場合に，基底クラスから別の基底クラスにキャストする」キャストを
クロスキャスト (cross cast) と呼ぶ．
この2種類のキャストは，コンパイル時には安全にキャストできるかどうかわからないため，```dynamic_cast``` を使って実行時にキャストする．